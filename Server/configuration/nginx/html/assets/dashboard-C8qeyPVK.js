import{u as T,r as l,j as e,B as a,A as N,T as m,f as v,S as p,L as R,a as C,b as k,v as H,P as q,M as U,c as V,m as X,I as D,d as J,D as K,H as Q}from"./index-B5amCMvG.js";import{C as Y}from"./config-global-DGEDRhMa.js";import{s as Z,a as ee,l as ne}from"./performance-view-DpFyTFSY.js";import{C as te,S as M}from"./Card-DyowOMVq.js";import{A as se,a as re}from"./Autocomplete-BjT5HKwe.js";import{T as ie}from"./TextField-me7Emq8m.js";import{L as oe}from"./loading_page-CrTw6y4A.js";import{D as ae,A as ce}from"./main-CpNDk0-m.js";import{G as F}from"./Grid2-Bzyb7laO.js";import"./format-number-PPx7ETe2.js";import"./colorManipulator-BMsPTI4f.js";import"./LoadingButton-Dr8ggdzP.js";import"./Grid-19EMHiyc.js";import"./Select-DWb8EsNp.js";function le({sx:c,post:n,liveData:s,...i}){var I;const h=T(),[f,j]=l.useState(0),[u,g]=l.useState("");l.useEffect(()=>{const r=new Date(n.start_product),z=new Date().getTime()-r.getTime(),B=Math.floor(z/1e3),S=Math.floor(B/60),P=Math.floor(S/60),L=S%60;g(`${P>=0?P:"XX"} ชั่วโมง ${L>=0?L:"XX"} นาที`);const G=((n==null?void 0:n.mode_pcs_count)>(n==null?void 0:n.mode_gram_count)?n.mode_pcs_count:n.mode_gram_count)/n.batch_size*100;j(G)},[n]);const b=r=>()=>{r.lot_number?h("/details",{state:r}):M.fire({icon:"question",title:`เครื่อง ${r.machine}`,text:"ไม่พบข้อมูลการผลิต, ยังไม่มีข้อมูลการผลิตในวันนี้!",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"+ เพิ่มข้อมูล"}).then(y=>{y.isConfirmed&&h("/production/form",{state:{row:{machine:r.machine}}})})},d=r=>()=>{h("/machine-setting/form",{state:{post:{device_id:r.device_id,serial_number_1:r.serial_number_1,serial_number_2:r.serial_number_2,machine:r.machine,machine_id:r.machine_id,machine_img:r.machine_img,group_name:r.group_name}}})},w=r=>()=>{h("/performance",{state:r})},t=e.jsx(a,{component:"img",alt:n.machine,src:n.machine_img?n.machine_img:"/assets/images/machine/default.png",sx:{top:0,width:1,height:1,objectFit:"cover",position:"absolute"}}),o=e.jsx(p,{width:88,height:36,src:"/assets/icons/shape-avatar.svg",sx:{left:0,zIndex:9,bottom:-16,position:"absolute",color:"background.paper"}}),x=e.jsx(N,{alt:n.machine,src:n.group_img?n.group_img:"/assets/images/machine/default.png",sx:{left:24,zIndex:9,bottom:-24,position:"absolute"}}),O=e.jsxs(e.Fragment,{children:[e.jsx(m,{variant:"body1",component:"div",sx:{color:"darkcyan"},children:`เลขที่ผลิต ${n.lot_number?n.lot_number:"XXXXXX"}`}),e.jsx(m,{variant:"body1",component:"div",sx:{color:"darkcyan"},children:`ชื่อยา ${n.product_name?n.product_name:"XXXXXX"}`}),e.jsxs(m,{variant:"body2",component:"div",sx:{mb:1,color:"grey"},children:[`เริ่มการผลิต ${n.start_product?v(n.start_product):"--/--/----, --:--"}`,e.jsx("br",{}),`จบการผลิต ${n.finish_product?v(n.finish_product):"--/--/----, --:--"}`]})]}),E=e.jsxs(a,{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",children:[e.jsx(m,{variant:"body1",component:"div",sx:{fontSize:"18px",color:"cornflowerblue",textDecoration:"underline",fontWeight:"400"},children:n.machine}),e.jsxs(a,{gap:.1,display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(p,{width:15,height:15,src:"/assets/icons/iconify/si-clock-duotone.svg",sx:{mb:.3,mr:.3,color:"#40BC14"}}),e.jsx(m,{variant:"body2",component:"div",sx:{color:"text.disabled"},children:u})]})]}),A=e.jsxs(a,{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",children:[e.jsx(m,{variant:"caption",component:"div",sx:{color:"text.disabled"},children:n.connection?v(n.connection):"--/--/----, --:--:--"}),e.jsxs(a,{gap:.1,display:"flex",alignItems:"center",justifyContent:"start",mt:.5,children:[e.jsx(p,{width:15,height:15,src:s!=null&&s.status?"/assets/icons/iconify/ic-round-lens.svg":"/assets/icons/iconify/line-md--downloading-loop.svg",sx:{mb:.1,color:Z[(s==null?void 0:s.status)??"LOADING"]}}),e.jsx(m,{variant:"body2",component:"div",sx:{color:"text.disabled"},children:s!=null&&s.status?ee[(s==null?void 0:s.status)??"STOP"]:"Loading..."})]})]}),W=e.jsxs(e.Fragment,{children:[e.jsxs(a,{gap:1.5,display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",sx:{mt:1,color:"text.disabled"},children:[e.jsx(m,{variant:"body2",sx:{mr:.5},children:"การผลิต"}),e.jsxs(m,{variant:"body2",children:[(n==null?void 0:n.mode_pcs_count)>(n==null?void 0:n.mode_gram_count)?n.mode_pcs_count.toLocaleString():n.mode_gram_count.toLocaleString(),"/",n.batch_size>0?n.batch_size.toLocaleString():"X,XXX"]})]}),e.jsx(a,{sx:{width:"100%"},children:e.jsx(R,{variant:"determinate",color:"success",sx:{height:15,borderRadius:1},value:f})})]});a,a,[{number:n.mode_gram_count,unit:"Gram",color:"primary.main",icon:"skill-icons:unity-light"},{number:n.mode_pcs_count,unit:"Pcs",color:"secondary.main",icon:"material-symbols:scale"}].map((r,y)=>e.jsxs(a,{display:"flex",children:[e.jsx(m,{variant:"body1",sx:{mr:.5,color:r.color,fontWeight:"500"},children:r.unit}),e.jsx(m,{variant:"body1",sx:{fontWeight:"500"},children:r.number.toLocaleString()})]},y));const $=e.jsx(e.Fragment,{children:e.jsxs(a,{gap:1.5,display:"flex",flexWrap:"wrap",justifyContent:"space-between",alignItems:"center",sx:{mt:2},children:[e.jsxs(a,{gap:1,display:"flex",flexWrap:"wrap",alignItems:"center",children:[e.jsx(C,{title:"ตั้งค่าเครื่องจักร",children:e.jsx(p,{onClick:d(n),width:30,height:30,src:"/assets/icons/iconify/solar--settings-bold-duotone.svg",sx:{cursor:"pointer",color:"text.disabled"}})}),e.jsx(C,{title:"ข้อมูลการผลิต",children:e.jsx(p,{onClick:b(n),width:30,height:30,src:"/assets/icons/iconify/fluent--clipboard-text-edit-48-filled.svg",sx:{cursor:"pointer",mr:.5,color:"text.disabled"}})}),e.jsx(C,{title:"ประสิทธิภาพการผลิต",children:e.jsx(p,{onClick:w(n),width:30,height:30,src:"/assets/icons/navbar/ic-performance.svg",sx:{cursor:"pointer",mr:.5,color:"text.disabled"}})})]}),e.jsxs(a,{display:"flex",children:[e.jsx(m,{variant:"body1",sx:{mr:.5,color:"primary.main",fontWeight:"500"},children:"SPEED"}),e.jsx(m,{variant:"body1",sx:{fontWeight:"500",color:"#868686"},children:((I=s==null?void 0:s.cpm)==null?void 0:I.toFixed(2))||"0.00"})]})]})});return e.jsxs(te,{sx:c,...i,children:[e.jsxs(a,{sx:r=>({position:"relative",pt:"calc(100% * 3 / 4)"}),children:[o,x,t]}),e.jsxs(a,{sx:r=>({p:r.spacing(6,3,3,3)}),children:[O,E,A,W,$]})]})}function de({options:c,filterBy:n,onFilter:s,sx:i,...h}){var b;const[f,j]=l.useState(null),u=l.useCallback(d=>{j(d.currentTarget)},[]),g=l.useCallback(()=>{j(null)},[]);return e.jsxs(e.Fragment,{children:[e.jsx(k,{disableRipple:!0,color:"inherit",onClick:u,endIcon:e.jsx(p,{width:30,height:30,src:f?"/assets/icons/iconify/eva--chevron-up-fill.svg":"/assets/icons/iconify/eva--chevron-down-fill.svg",sx:{ml:-1}}),sx:{bgcolor:d=>H(d.vars.palette.grey["500Channel"],.08),...i},...h,children:(b=c.find(d=>d.value===n))==null?void 0:b.label}),e.jsx(q,{open:!!f,anchorEl:f,onClose:g,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(U,{disablePadding:!0,sx:{p:.5,gap:.5,width:160,display:"flex",flexDirection:"column",[`& .${X.root}`]:{px:1,gap:2,borderRadius:.75,[`&.${X.selected}`]:{bgcolor:"action.selected"}}},children:c.map(d=>e.jsx(V,{selected:d.value===n,onClick:()=>{s(d.value),g()},children:d.label},d.value))})})]})}function me({posts:c,onSearch:n,sx:s}){return e.jsx(se,{sx:{width:280},autoHighlight:!0,freeSolo:!0,onInputChange:n,popupIcon:null,slotProps:{paper:{sx:{width:320,[`& .${re.option}`]:{typography:"body2"},...s}}},options:c,getOptionLabel:i=>typeof i=="string"?i:i.machine,isOptionEqualToValue:(i,h)=>i.machine===h.machine,renderInput:i=>e.jsx(ie,{...i,placeholder:"ค้นหาเครื่องจักร...",InputProps:{...i.InputProps,startAdornment:e.jsx(D,{position:"start",children:e.jsx(J,{children:e.jsx("path",{fill:"currentColor",d:"m20.71 19.29l-3.4-3.39A7.92 7.92 0 0 0 19 11a8 8 0 1 0-8 8a7.92 7.92 0 0 0 4.9-1.69l3.39 3.4a1 1 0 0 0 1.42 0a1 1 0 0 0 0-1.42M5 11a6 6 0 1 1 6 6a6 6 0 0 1-6-6"})})})}})})}function he({inputData:c,filterName:n}){return c=c.map((i,h)=>[i,h]).map(i=>i[0]),n&&(c=c.filter(i=>i.machine.toLowerCase().indexOf(n.toLowerCase())!==-1||i.group_name.toLowerCase().indexOf(n.toLowerCase())!==-1)),c}const _=ne(ce.BASE_URL,{transports:["websocket"]});function ue(){const c=T(),[n,s]=l.useState(""),[i,h]=l.useState([]),[f,j]=l.useState(!0),[u,g]=l.useState([]),b=l.useRef(new Set);l.useEffect(()=>(u.forEach(t=>{b.current.has(t.machine_id)||(_.emit("subscribe",t.machine_id),b.current.add(t.machine_id),console.log(`Subscribed to machine_id: ${t.machine_id}`))}),_.on("subscribed",t=>{console.log("Subscribed to topic:",t.topic)}),_.on("machine-data",t=>{g(o=>o.map(x=>x.machine_id===t.machine_id?{...x,liveData:t}:x))}),()=>{_.off("subscribed"),_.off("machine-data")}),[u]),l.useEffect(()=>{const t=setTimeout(()=>{g(o=>o.map(x=>({...x,liveData:{machine_id:x.machine_id,status:"OFFLINE",cycle_time:0,cpm:0,good_path_count:0,reject_count:0,start_time:0,stop_time:0,timestamp:"--/--/----, --:--"}})))},5e3);return()=>clearTimeout(t)},[u]),l.useEffect(()=>{(async()=>{try{const o=await ae();j(!1),g(o),console.log(o),h([...new Set([...o.map(x=>x.group_name)])])}catch(o){o.status===401||o.status===403?c("/login"):(M.fire({icon:"error",title:"เกิดข้อผิดพลาด...",text:"ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้!",showConfirmButton:!1}),console.error("Error fetching data:",o))}})()},[f,c]);const d=he({inputData:u,filterName:n}),w=l.useCallback(t=>{s(t)},[]);return e.jsxs(e.Fragment,{children:[e.jsx(oe,{isShowing:f}),e.jsxs(K,{children:[e.jsxs(a,{display:"flex",alignItems:"center",mb:5,children:[e.jsx(m,{variant:"h4",flexGrow:1,children:"Dashboard"}),e.jsx(k,{variant:"contained",color:"inherit",onClick:()=>{c("/machine-setting/form")},startIcon:e.jsx(p,{src:"/assets/icons/iconify/add.svg",width:"20px",height:"20px"}),children:"เพิ่มรายการเครื่องจักร"})]}),e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",sx:{mb:5},children:[e.jsx(me,{posts:u,onSearch:(t,o)=>{s(o)}}),e.jsx(de,{filterBy:n,onFilter:w,options:[{value:"",label:"Groups..."},...i.map(t=>({value:t,label:t}))]})]}),e.jsx(F,{container:!0,spacing:3,children:f?"":(n?d:u).map((t,o)=>e.jsx(F,{xs:12,sm:6,md:4,xl:3,children:e.jsx(le,{post:t,liveData:t.liveData})},t.machine+o))})]})]})}function Fe(){return e.jsxs(e.Fragment,{children:[e.jsx(Q,{children:e.jsxs("title",{children:[" ",`Dashboard - ${Y.appName}`]})}),e.jsx(ue,{})]})}export{Fe as default};
