import{u as $,r as d,j as e,B as c,A as N,T as h,f as E,S as b,L as R,a as M,b as z,v as H,P as q,M as U,c as V,m as A,I as J,d as K,D as Q,p as Y,H as Z}from"./index-Bhw5Yxrc.js";import{C as ee}from"./config-global-DGEDRhMa.js";import{s as te,a as ne,l as se}from"./performance-view-hG6RLjP7.js";import{C as ie,S as B}from"./Card-CHhQk-r8.js";import{A as ae,a as re}from"./Autocomplete-x1pQLomw.js";import{T as oe}from"./TextField-DXYY4TfV.js";import{L as ce}from"./loading_page-C058tvp2.js";import{D as le,A as de}from"./main-DqsJbxx5.js";import{G as W}from"./Grid2-DQ0xWP17.js";import"./format-number-DEIGPY-6.js";import"./colorManipulator-Ckid2Ts_.js";import"./LoadingButton-u6Eb6aPb.js";import"./Grid-INbjnGBp.js";import"./Select-B0IoYeGo.js";function me({sx:l,post:t,liveData:i,...a}){var v;const u=$(),[f,y]=d.useState(0),[x,p]=d.useState("");d.useEffect(()=>{const s=new Date(t.start_product),P=new Date().getTime()-s.getTime(),T=Math.floor(P/1e3),w=Math.floor(T/60),C=Math.floor(w/60),D=w%60;p(`${C>=0?C:"XX"} ชั่วโมง ${D>=0?D:"XX"} นาที`);const G=((t==null?void 0:t.mode_pcs_count)>(t==null?void 0:t.mode_gram_count)?t.mode_pcs_count:t.mode_gram_count)/t.batch_size*100;y(G)},[t,t.liveData]);const j=s=>()=>{s.lot_number?u("/details",{state:s}):B.fire({icon:"question",title:`เครื่อง ${s.machine}`,text:"ไม่พบข้อมูลการผลิต, ยังไม่มีข้อมูลการผลิตในวันนี้!",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"+ เพิ่มข้อมูล"}).then(_=>{_.isConfirmed&&u("/production/form",{state:{row:{machine:s.machine}}})})},m=s=>()=>{u("/machine-setting/form",{state:{post:{device_id:s.device_id,serial_number_1:s.serial_number_1,serial_number_2:s.serial_number_2,machine:s.machine,machine_id:s.machine_id,machine_img:s.machine_img,group_name:s.group_name}}})},F=s=>()=>{u("/performance",{state:s})},X=e.jsx(c,{component:"img",alt:t.machine,src:t.machine_img?t.machine_img:"/assets/images/machine/default.png",sx:{top:0,width:1,height:1,objectFit:"cover",position:"absolute"}}),n=e.jsx(b,{width:88,height:36,src:"/assets/icons/shape-avatar.svg",sx:{left:0,zIndex:9,bottom:-16,position:"absolute",color:"background.paper"}}),o=e.jsx(N,{alt:t.machine,src:t.group_img?t.group_img:"/assets/images/machine/default.png",sx:{left:24,zIndex:9,bottom:-24,position:"absolute"}}),r=e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"body1",component:"div",sx:{color:"darkcyan"},children:`เลขที่ผลิต ${t.lot_number?t.lot_number:"XXXXXX"}`}),e.jsx(h,{variant:"body1",component:"div",sx:{color:"darkcyan"},children:`ชื่อยา ${t.product_name?t.product_name:"XXXXXX"}`}),e.jsxs(h,{variant:"body2",component:"div",sx:{mb:1,color:"grey"},children:[`เริ่มการผลิต ${t.start_product?E(t.start_product):"--/--/----, --:--"}`,e.jsx("br",{}),`จบการผลิต ${t.finish_product?E(t.finish_product):"--/--/----, --:--"}`]})]}),k=e.jsxs(c,{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",children:[e.jsx(h,{variant:"body1",component:"div",sx:{fontSize:"18px",color:"cornflowerblue",textDecoration:"underline",fontWeight:"400"},children:t.machine}),e.jsxs(c,{gap:.1,display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(b,{width:15,height:15,src:"/assets/icons/iconify/si-clock-duotone.svg",sx:{mb:.3,mr:.3,color:"#40BC14"}}),e.jsx(h,{variant:"body2",component:"div",sx:{color:"text.disabled"},children:x})]})]}),g=e.jsxs(c,{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",children:[e.jsx(h,{variant:"caption",component:"div",sx:{color:"text.disabled"},children:t.connection?E(t.connection):"--/--/----, --:--:--"}),e.jsxs(c,{gap:.1,display:"flex",alignItems:"center",justifyContent:"start",children:[e.jsx(b,{width:15,height:15,src:i!=null&&i.status?"/assets/icons/iconify/ic-round-lens.svg":"/assets/icons/iconify/line-md--downloading-loop.svg",sx:{mb:.1,color:te[(i==null?void 0:i.status)??"LOADING"]}}),e.jsx(h,{variant:"body2",component:"div",sx:{color:"text.disabled"},children:i!=null&&i.status?ne[(i==null?void 0:i.status)||"OFFLINE"]:"Loading..."})]})]}),S=e.jsxs(e.Fragment,{children:[e.jsxs(c,{gap:1.5,display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",sx:{mt:1,color:"text.disabled"},children:[e.jsx(h,{variant:"body2",sx:{mr:.5},children:"การผลิต"}),e.jsxs(h,{variant:"body2",children:[(t==null?void 0:t.mode_pcs_count)>(t==null?void 0:t.mode_gram_count)?t.mode_pcs_count.toLocaleString():t.mode_gram_count.toLocaleString(),"/",t.batch_size>0?t.batch_size.toLocaleString():"X,XXX"]})]}),e.jsx(c,{sx:{width:"100%"},children:e.jsx(R,{variant:"determinate",color:"success",sx:{height:15,borderRadius:1},value:f})})]});c,c,[{number:t.mode_gram_count,unit:"Gram",color:"primary.main",icon:"skill-icons:unity-light"},{number:t.mode_pcs_count,unit:"Pcs",color:"secondary.main",icon:"material-symbols:scale"}].map((s,_)=>e.jsxs(c,{display:"flex",children:[e.jsx(h,{variant:"body1",sx:{mr:.5,color:s.color,fontWeight:"500"},children:s.unit}),e.jsx(h,{variant:"body1",sx:{fontWeight:"500"},children:s.number.toLocaleString()})]},_));const L=e.jsx(e.Fragment,{children:e.jsxs(c,{gap:1.5,display:"flex",flexWrap:"wrap",justifyContent:"space-between",alignItems:"center",sx:{mt:2},children:[e.jsxs(c,{gap:1,display:"flex",flexWrap:"wrap",alignItems:"center",children:[e.jsx(M,{title:"ตั้งค่าเครื่องจักร",children:e.jsx(b,{onClick:m(t),width:30,height:30,src:"/assets/icons/iconify/solar--settings-bold-duotone.svg",sx:{cursor:"pointer",color:"text.disabled"}})}),e.jsx(M,{title:"ข้อมูลการผลิต",children:e.jsx(b,{onClick:j(t),width:30,height:30,src:"/assets/icons/iconify/fluent--clipboard-text-edit-48-filled.svg",sx:{cursor:"pointer",mr:.5,color:"text.disabled"}})}),e.jsx(M,{title:"ประสิทธิภาพการผลิต",children:e.jsx(b,{onClick:F(t),width:30,height:30,src:"/assets/icons/navbar/ic-performance.svg",sx:{cursor:"pointer",mr:.5,color:"text.disabled"}})})]}),e.jsxs(c,{display:"flex",children:[e.jsx(h,{variant:"body1",sx:{mr:.5,color:"primary.main",fontWeight:"500"},children:"SPEED"}),e.jsx(h,{variant:"body1",sx:{fontWeight:"500",color:"#868686"},children:((v=i==null?void 0:i.cpm)==null?void 0:v.toFixed(2))||"0.00"})]})]})});return e.jsxs(ie,{sx:l,...a,children:[e.jsxs(c,{sx:s=>({position:"relative",pt:"calc(100% * 3 / 4)"}),children:[n,o,X]}),e.jsxs(c,{sx:s=>({p:s.spacing(6,3,3,3)}),children:[r,k,g,S,L]})]})}function he({options:l,filterBy:t,onFilter:i,sx:a,...u}){var j;const[f,y]=d.useState(null),x=d.useCallback(m=>{y(m.currentTarget)},[]),p=d.useCallback(()=>{y(null)},[]);return e.jsxs(e.Fragment,{children:[e.jsx(z,{disableRipple:!0,color:"inherit",onClick:x,endIcon:e.jsx(b,{width:30,height:30,src:f?"/assets/icons/iconify/eva--chevron-up-fill.svg":"/assets/icons/iconify/eva--chevron-down-fill.svg",sx:{ml:-1}}),sx:{bgcolor:m=>H(m.vars.palette.grey["500Channel"],.08),...a},...u,children:(j=l.find(m=>m.value===t))==null?void 0:j.label}),e.jsx(q,{open:!!f,anchorEl:f,onClose:p,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(U,{disablePadding:!0,sx:{p:.5,gap:.5,width:160,display:"flex",flexDirection:"column",[`& .${A.root}`]:{px:1,gap:2,borderRadius:.75,[`&.${A.selected}`]:{bgcolor:"action.selected"}}},children:l.map(m=>e.jsx(V,{selected:m.value===t,onClick:()=>{i(m.value),p()},children:m.label},m.value))})})]})}function ue({posts:l,onSearch:t,sx:i}){return e.jsx(ae,{sx:{width:280},autoHighlight:!0,freeSolo:!0,onInputChange:t,popupIcon:null,slotProps:{paper:{sx:{width:320,[`& .${re.option}`]:{typography:"body2"},...i}}},options:l,getOptionLabel:a=>typeof a=="string"?a:a.machine,isOptionEqualToValue:(a,u)=>a.machine===u.machine,renderInput:a=>e.jsx(oe,{...a,placeholder:"ค้นหาเครื่องจักร...",InputProps:{...a.InputProps,startAdornment:e.jsx(J,{position:"start",children:e.jsx(K,{children:e.jsx("path",{fill:"currentColor",d:"m20.71 19.29l-3.4-3.39A7.92 7.92 0 0 0 19 11a8 8 0 1 0-8 8a7.92 7.92 0 0 0 4.9-1.69l3.39 3.4a1 1 0 0 0 1.42 0a1 1 0 0 0 0-1.42M5 11a6 6 0 1 1 6 6a6 6 0 0 1-6-6"})})})}})})}function xe({inputData:l,filterName:t}){return l=l.map((a,u)=>[a,u]).map(a=>a[0]),t&&(l=l.filter(a=>a.machine.toLowerCase().indexOf(t.toLowerCase())!==-1||a.group_name.toLowerCase().indexOf(t.toLowerCase())!==-1)),l}const I=se(de.BASE_URL,{transports:["websocket"]});function fe(){const l=$(),[t,i]=d.useState(""),[a,u]=d.useState([]),[f,y]=d.useState(!0),[x,p]=d.useState([]),j=d.useRef(new Set);d.useEffect(()=>(x.forEach(n=>{j.current.has(n.machine_id)||(I.emit("subscribe",n.machine_id),j.current.add(n.machine_id),console.log(`Subscribed to machine_id: ${n.machine_id}`))}),I.on("subscribed",n=>{console.log("Subscribed to topic:",n.topic)}),I.on("machine-data",n=>{p(o=>o.map(r=>r.machine_id===n.machine_id?{...r,liveData:n}:r))}),()=>{I.off("subscribed"),I.off("machine-data")}),[x]);const m=()=>{console.log("Checking machine status...");const n=new Date().getTime();p(o=>o.map(r=>{var S,L,v,s,_,P,T,w,O,C;const k=(S=r.liveData)!=null&&S.timestamp?Y(r.liveData.timestamp):0,g=n-k>5e3;return{...r,liveData:{...r.liveData,machine_id:((L=r.liveData)==null?void 0:L.machine_id)||"",status:g?"OFFLINE":((v=r.liveData)==null?void 0:v.status)||"ONLINE",cycle_time:g?0:((s=r.liveData)==null?void 0:s.cycle_time)||0,cpm:g?0:((_=r.liveData)==null?void 0:_.cpm)||0,good_path_count:g?0:((P=r.liveData)==null?void 0:P.good_path_count)||0,reject_count:g?0:((T=r.liveData)==null?void 0:T.reject_count)||0,start_time:g?0:((w=r.liveData)==null?void 0:w.start_time)||0,stop_time:g?0:((O=r.liveData)==null?void 0:O.stop_time)||0,timestamp:((C=r.liveData)==null?void 0:C.timestamp)||"--/--/----, --:--"}}}))};d.useEffect(()=>{const n=setTimeout(m,5e3);return()=>clearTimeout(n)},[]),d.useEffect(()=>{const n=setTimeout(m,5e3);return()=>clearTimeout(n)},[x]),d.useEffect(()=>{(async()=>{try{const o=await le();y(!1),p(o),console.log(o),u([...new Set([...o.map(r=>r.group_name)])])}catch(o){o.status===401||o.status===403?l("/login"):(B.fire({icon:"error",title:"เกิดข้อผิดพลาด...",text:"ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้!",showConfirmButton:!1}),console.error("Error fetching data:",o))}})()},[f,l]);const F=xe({inputData:x,filterName:t}),X=d.useCallback(n=>{i(n)},[]);return e.jsxs(e.Fragment,{children:[e.jsx(ce,{isShowing:f}),e.jsxs(Q,{children:[e.jsxs(c,{display:"flex",alignItems:"center",mb:5,children:[e.jsx(h,{variant:"h4",flexGrow:1,children:"Dashboard"}),e.jsx(z,{variant:"contained",color:"inherit",onClick:()=>{l("/machine-setting/form")},startIcon:e.jsx(b,{src:"/assets/icons/iconify/add.svg",width:"20px",height:"20px"}),children:"เพิ่มรายการเครื่องจักร"})]}),e.jsxs(c,{display:"flex",alignItems:"center",justifyContent:"space-between",sx:{mb:5},children:[e.jsx(ue,{posts:x,onSearch:(n,o)=>{i(o)}}),e.jsx(he,{filterBy:t,onFilter:X,options:[{value:"",label:"Groups..."},...a.map(n=>({value:n,label:n}))]})]}),e.jsx(W,{container:!0,spacing:3,children:f?"":(t?F:x).map((n,o)=>e.jsx(W,{xs:12,sm:6,md:4,xl:3,children:e.jsx(me,{post:n,liveData:n.liveData})},n.machine+o))})]})]})}function Xe(){return e.jsxs(e.Fragment,{children:[e.jsx(Z,{children:e.jsxs("title",{children:[" ",`Dashboard - ${ee.appName}`]})}),e.jsx(fe,{})]})}export{Xe as default};
