import{u as z,r as d,j as e,B as c,A as R,T as h,f as O,S as _,L as H,a as E,b as B,v as D,P as q,M as U,c as V,m as W,I as J,d as K,D as Q,p as Y,H as Z}from"./index-DFRRmdgx.js";import{C as ee}from"./config-global-DQeLXOlG.js";import{s as ne,a as te,l as se}from"./performance-view-BuU_f1XY.js";import{C as ae,S as G}from"./Card-DeHUnrhc.js";import{A as re,a as oe}from"./Autocomplete-Brj5EiI4.js";import{T as ie}from"./TextField-CVIl4HcS.js";import{L as ce}from"./loading_page-CWAaSiNY.js";import{D as le,A as de}from"./main-BLXQ8eMX.js";import{G as $}from"./Grid2-B23NRJ1R.js";import"./chart-legends-BSKEdJyU.js";import"./Stack-fyjKT1yZ.js";import"./colorManipulator-kcRzv3LA.js";import"./format-number-K6Y1r_qy.js";import"./LoadingButton-DJbODUAf.js";import"./Grid-CNG59LoI.js";import"./CardContent-BY8C5yS_.js";import"./Select-D5j-WpuF.js";function me({sx:l,post:n,liveData:t,...o}){var w;const u=z(),[f,y]=d.useState(0),[x,g]=d.useState("");d.useEffect(()=>{const a=new Date(n.start_product),P=new Date().getTime()-a.getTime(),T=Math.floor(P/1e3),v=Math.floor(T/60),C=Math.floor(v/60),A=v%60;g(`${C>=0?C:"XX"} ชั่วโมง ${A>=0?A:"XX"} นาที`);const N=((n==null?void 0:n.mode_pcs_count)>(n==null?void 0:n.mode_gram_count)?n.mode_pcs_count:n.mode_gram_count)/n.batch_size*100;y(N)},[n,n.liveData]);const b=a=>()=>{a.lot_number?u("/details",{state:a}):G.fire({icon:"question",title:`เครื่อง ${a.machine_name_en}`,text:"ไม่พบข้อมูลการผลิต, ยังไม่มีข้อมูลการผลิตในวันนี้!",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"+ เพิ่มข้อมูล"}).then(j=>{j.isConfirmed&&u("/production/form",{state:{row:a}})})},m=a=>()=>{u("/machine-setting/form",{state:{post:{machine_id:a.machine_id,alarm_box_sn_1:a.alarm_box_sn_1,alarm_box_sn_2:a.alarm_box_sn_2,machine_name_en:a.machine_name_en,machine_sn:a.machine_sn,machine_image:a.machine_image,group_name:a.group_name}}})},F=a=>()=>{u("/performance",{state:a})},X=e.jsx(c,{component:"img",alt:n.machine_name_en,src:n.machine_image?n.machine_image:"/assets/images/machine/default.png",sx:{top:0,width:1,height:1,objectFit:"cover",position:"absolute"}}),s=e.jsx(_,{width:88,height:36,src:"/assets/icons/shape-avatar.svg",sx:{left:0,zIndex:9,bottom:-16,position:"absolute",color:"background.paper"}}),i=e.jsx(R,{alt:n.machine_name_en,src:n.group_image?n.group_image:"/assets/images/machine_group/default.png",sx:{left:24,zIndex:9,bottom:-24,position:"absolute"}}),r=e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"body1",component:"div",sx:{color:"darkcyan"},children:`เลขที่ผลิต ${n.lot_number?n.lot_number:"XXXXXX"}`}),e.jsx(h,{variant:"body1",component:"div",sx:{color:"darkcyan"},children:`ชื่อยา ${n.product_name?n.product_name:"XXXXXX"}`}),e.jsxs(h,{variant:"body2",component:"div",sx:{mb:1,color:"grey"},children:[`เริ่มการผลิต ${n.start_product?O(n.start_product):"--/--/----, --:--"}`,e.jsx("br",{}),`จบการผลิต ${n.finish_product?O(n.finish_product):"--/--/----, --:--"}`]})]}),k=e.jsxs(c,{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",children:[e.jsx(h,{variant:"body1",component:"div",sx:{fontSize:"19px",color:"cornflowerblue",textDecoration:"underline",fontWeight:"600"},children:n.machine_name_en}),e.jsxs(c,{gap:.1,display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(_,{width:15,height:15,src:"/assets/icons/iconify/si-clock-duotone.svg",sx:{mb:.3,mr:.3,color:"#40BC14"}}),e.jsx(h,{variant:"body2",component:"div",sx:{color:"text.disabled"},children:x})]})]}),p=e.jsxs(c,{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",children:[e.jsx(h,{variant:"caption",component:"div",sx:{color:"text.disabled"},children:t!=null&&t.timestamp?O(t.timestamp)??(t==null?void 0:t.timestamp):"--/--/----, --:--:--"}),e.jsxs(c,{gap:.1,display:"flex",alignItems:"center",justifyContent:"start",children:[e.jsx(_,{width:15,height:15,src:t!=null&&t.status?"/assets/icons/iconify/ic-round-lens.svg":"/assets/icons/iconify/line-md--downloading-loop.svg",sx:{mb:.1,color:ne[(t==null?void 0:t.status)??"LOADING"]}}),e.jsx(h,{variant:"body2",component:"div",sx:{color:"text.disabled"},children:t!=null&&t.status?te[(t==null?void 0:t.status)||"OFFLINE"]:"Loading..."})]})]}),S=e.jsxs(e.Fragment,{children:[e.jsxs(c,{gap:1.5,display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",sx:{mt:1,color:"text.disabled"},children:[e.jsx(h,{variant:"body2",sx:{mr:.5},children:"การผลิต"}),e.jsxs(h,{variant:"body2",children:[(n==null?void 0:n.mode_pcs_count)>(n==null?void 0:n.mode_gram_count)?n.mode_pcs_count.toLocaleString():n.mode_gram_count.toLocaleString(),"/",n.batch_size>0?n.batch_size.toLocaleString():"X,XXX"]})]}),e.jsx(c,{sx:{width:"100%"},children:e.jsx(H,{variant:"determinate",color:"success",sx:{height:15,borderRadius:1},value:f})})]});c,c,[{number:n.mode_gram_count,unit:"Gram",color:"primary.main",icon:"skill-icons:unity-light"},{number:n.mode_pcs_count,unit:"Pcs",color:"secondary.main",icon:"material-symbols:scale"}].map((a,j)=>e.jsxs(c,{display:"flex",children:[e.jsx(h,{variant:"body1",sx:{mr:.5,color:a.color,fontWeight:"500"},children:a.unit}),e.jsx(h,{variant:"body1",sx:{fontWeight:"500"},children:a.number.toLocaleString()})]},j));const L=e.jsx(e.Fragment,{children:e.jsxs(c,{gap:1.5,display:"flex",flexWrap:"wrap",justifyContent:"space-between",alignItems:"center",sx:{mt:2},children:[e.jsxs(c,{gap:1,display:"flex",flexWrap:"wrap",alignItems:"center",children:[e.jsx(E,{title:"ตั้งค่าเครื่องจักร",children:e.jsx(_,{onClick:m(n),width:30,height:30,src:"/assets/icons/iconify/solar--settings-bold-duotone.svg",sx:{cursor:"pointer",color:"text.disabled"}})}),e.jsx(E,{title:"ข้อมูลการผลิต",children:e.jsx(_,{onClick:b(n),width:30,height:30,src:"/assets/icons/iconify/fluent--clipboard-text-edit-48-filled.svg",sx:{cursor:"pointer",mr:.5,color:"text.disabled"}})}),e.jsx(E,{title:"ประสิทธิภาพการผลิต",children:e.jsx(_,{onClick:F(n),width:30,height:30,src:"/assets/icons/navbar/ic-performance.svg",sx:{cursor:"pointer",mr:.5,color:"text.disabled"}})})]}),e.jsxs(c,{display:"flex",children:[e.jsx(h,{variant:"body1",sx:{mr:.5,color:"primary.main",fontWeight:"500"},children:"SPEED"}),e.jsx(h,{variant:"body1",sx:{fontWeight:"500",color:"#868686"},children:((w=t==null?void 0:t.cpm)==null?void 0:w.toFixed(2))||"0.00"})]})]})});return e.jsxs(ae,{sx:l,...o,children:[e.jsxs(c,{sx:a=>({position:"relative",pt:"calc(100% * 3 / 4)"}),children:[s,i,X]}),e.jsxs(c,{sx:a=>({p:a.spacing(5,3,2,3)}),children:[r,k,p,S,L]})]})}function he({options:l,filterBy:n,onFilter:t,sx:o,...u}){var b;const[f,y]=d.useState(null),x=d.useCallback(m=>{y(m.currentTarget)},[]),g=d.useCallback(()=>{y(null)},[]);return e.jsxs(e.Fragment,{children:[e.jsx(B,{disableRipple:!0,color:"inherit",onClick:x,endIcon:e.jsx(_,{width:30,height:30,src:f?"/assets/icons/iconify/eva--chevron-up-fill.svg":"/assets/icons/iconify/eva--chevron-down-fill.svg",sx:{ml:-1}}),sx:{bgcolor:m=>D(m.vars.palette.grey["500Channel"],.08),...o},...u,children:(b=l.find(m=>m.value===n))==null?void 0:b.label}),e.jsx(q,{open:!!f,anchorEl:f,onClose:g,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(U,{disablePadding:!0,sx:{p:.5,gap:.5,width:160,display:"flex",flexDirection:"column",[`& .${W.root}`]:{px:1,gap:2,borderRadius:.75,[`&.${W.selected}`]:{bgcolor:"action.selected"}}},children:l.map(m=>e.jsx(V,{selected:m.value===n,onClick:()=>{t(m.value),g()},children:m.label},m.value))})})]})}function ue({posts:l,onSearch:n,sx:t}){return e.jsx(re,{sx:{width:280},autoHighlight:!0,freeSolo:!0,onInputChange:n,popupIcon:null,slotProps:{paper:{sx:{width:320,[`& .${oe.option}`]:{typography:"body2"},...t}}},options:l,getOptionLabel:o=>typeof o=="string"?o:o.machine_name_en,isOptionEqualToValue:(o,u)=>o.machine_name_en===u.machine_name_en,renderInput:o=>e.jsx(ie,{...o,placeholder:"ค้นหาเครื่องจักร...",InputProps:{...o.InputProps,startAdornment:e.jsx(J,{position:"start",children:e.jsx(K,{children:e.jsx("path",{fill:"currentColor",d:"m20.71 19.29l-3.4-3.39A7.92 7.92 0 0 0 19 11a8 8 0 1 0-8 8a7.92 7.92 0 0 0 4.9-1.69l3.39 3.4a1 1 0 0 0 1.42 0a1 1 0 0 0 0-1.42M5 11a6 6 0 1 1 6 6a6 6 0 0 1-6-6"})})})}})})}function xe({inputData:l,filterName:n}){return l=l.map((o,u)=>[o,u]).map(o=>o[0]),n&&(l=l.filter(o=>o.machine_name_en.toLowerCase().indexOf(n.toLowerCase())!==-1||o.group_name.toLowerCase().indexOf(n.toLowerCase())!==-1)),l}const I=se(de.BASE_URL,{transports:["websocket"]});function pe(){const l=z(),[n,t]=d.useState(""),[o,u]=d.useState([]),[f,y]=d.useState(!0),[x,g]=d.useState([]),b=d.useRef(new Set);d.useEffect(()=>(x.forEach(s=>{!b.current.has(s.machine_sn)&&s.machine_sn&&(I.emit("subscribe",s.machine_sn),b.current.add(s.machine_sn),console.log(`Subscribed to machine_sn: ${s.machine_sn}`))}),I.on("subscribed",s=>{console.log("Subscribed to topic:",s.topic)}),I.on("machine-data",s=>{g(i=>i.map(r=>r.machine_sn===s.machine_sn?{...r,liveData:s}:r))}),()=>{I.off("subscribed"),I.off("machine-data")}),[x]);const m=()=>{const s=new Date().getTime();g(i=>i.map(r=>{var S,L,w,a,j,P,T,v,M,C;const k=(S=r.liveData)!=null&&S.timestamp?Y(r.liveData.timestamp):0,p=s-k>1e4;return p?(console.log("Checking machine_name_en status..."),{...r,liveData:{...r.liveData,machine_sn:((L=r.liveData)==null?void 0:L.machine_sn)||"",status:p?"OFFLINE":((w=r.liveData)==null?void 0:w.status)||"",cycle_time:p?0:((a=r.liveData)==null?void 0:a.cycle_time)||0,cpm:p?0:((j=r.liveData)==null?void 0:j.cpm)||0,good_path_count:p?0:((P=r.liveData)==null?void 0:P.good_path_count)||0,reject_count:p?0:((T=r.liveData)==null?void 0:T.reject_count)||0,start_time:p?0:((v=r.liveData)==null?void 0:v.start_time)||0,stop_time:p?0:((M=r.liveData)==null?void 0:M.stop_time)||0,timestamp:((C=r.liveData)==null?void 0:C.timestamp)??""}}):r}))};d.useEffect(()=>{const s=setTimeout(m,5e3);return()=>clearTimeout(s)},[]),d.useEffect(()=>{const s=setTimeout(m,5e3);return()=>clearTimeout(s)},[x]),d.useEffect(()=>{(async()=>{try{const i=await le();y(!1),g(i),console.log("getData",i),u([...new Set([...i.map(r=>r.group_name)])])}catch(i){i.status===401||i.status===403?l("/login"):(G.fire({icon:"error",title:"เกิดข้อผิดพลาด...",text:"ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้!",showConfirmButton:!1}),console.error("Error fetching data:",i))}})()},[f,l]);const F=xe({inputData:x,filterName:n}),X=d.useCallback(s=>{t(s)},[]);return e.jsxs(e.Fragment,{children:[e.jsx(ce,{isShowing:f}),e.jsxs(Q,{children:[e.jsxs(c,{display:"flex",alignItems:"center",mb:5,children:[e.jsx(h,{variant:"h4",flexGrow:1,children:"Dashboard"}),e.jsx(B,{variant:"contained",color:"inherit",onClick:()=>{l("/machine-setting/form")},startIcon:e.jsx(_,{src:"/assets/icons/iconify/add.svg",width:"20px",height:"20px"}),children:"เพิ่มรายการเครื่องจักร"})]}),e.jsxs(c,{display:"flex",alignItems:"center",justifyContent:"space-between",sx:{mb:5},children:[e.jsx(ue,{posts:x,onSearch:(s,i)=>{t(i)}}),e.jsx(he,{filterBy:n,onFilter:X,options:[{value:"",label:"Groups..."},...o.map(s=>({value:s,label:s}))]})]}),e.jsx($,{container:!0,spacing:3,children:f?"":(n?F:x).map((s,i)=>e.jsx($,{xs:12,sm:6,md:4,xl:3,children:e.jsx(me,{post:s,liveData:s.liveData})},s.machine_name_en+i))})]})]})}function Oe(){return e.jsxs(e.Fragment,{children:[e.jsx(Z,{children:e.jsxs("title",{children:[" ",`Dashboard - ${ee.appName}`]})}),e.jsx(pe,{})]})}export{Oe as default};
